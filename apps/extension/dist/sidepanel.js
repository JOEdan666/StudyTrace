(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();const h="http://localhost:3001",O="http://localhost:3000",P=12e3;function N(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```(\w*)\n?([\s\S]*?)```/g,"<pre><code>$2</code></pre>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/__(.+?)__/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/_(.+?)_/g,"<em>$1</em>").replace(/^### (.+)$/gm,"<h4>$1</h4>").replace(/^## (.+)$/gm,"<h3>$1</h3>").replace(/^# (.+)$/gm,"<h2>$1</h2>").replace(/^[\-\*] (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>\n?)+/g,"<ul>$&</ul>").replace(/\n/g,"<br>")}let i=null,a=null,p=null;const I=document.getElementById("pageDomain"),d=document.getElementById("chatArea"),S=document.getElementById("welcomeState"),f=document.getElementById("chatInput"),b=document.getElementById("sendBtn"),k=document.getElementById("summarizeBtn"),L=document.getElementById("brainstormBtn"),g=document.getElementById("saveCardBtn"),T=document.getElementById("dashboardBtn");async function j(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(a=e,e!=null&&e.url)try{const t=new URL(e.url);I.textContent=t.hostname}catch{I.textContent="Unknown"}}async function y(){var t;if(!(a!=null&&a.id))throw new Error("No active tab");const e=await chrome.scripting.executeScript({target:{tabId:a.id},func:()=>{const r=document.body.cloneNode(!0);return r.querySelectorAll("script, style, noscript, iframe, svg").forEach(n=>n.remove()),(r.innerText||r.textContent||"").replace(/\s+/g," ").trim()}});if((t=e==null?void 0:e[0])!=null&&t.result)return p=e[0].result.slice(0,P),p;throw new Error("Failed to extract text")}function v(){S&&(S.style.display="none")}function E(e){v();const t=document.createElement("div");t.className="message message-user",t.textContent=e,d.appendChild(t),B()}function l(e,t={}){var n,o;v();const r=document.createElement("div");r.className="message message-ai";let s='<div class="message-label"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>AI 助手</div>';return s+=`<div class="message-content">${N(e)}</div>`,(n=t.keyPoints)!=null&&n.length&&(s+='<ul class="key-points">'+t.keyPoints.map(c=>`<li>${c}</li>`).join("")+"</ul>"),(o=t.tags)!=null&&o.length&&(s+='<div class="tags">'+t.tags.map(c=>`<span class="tag">${c}</span>`).join("")+"</div>"),r.innerHTML=s,d.appendChild(r),B(),r}function $(){v();const e=document.createElement("div");return e.className="message message-ai typing-container",e.innerHTML='<div class="typing"><span></span><span></span><span></span></div>',d.appendChild(e),B(),e}function m(){const e=d.querySelector(".typing-container");e&&e.remove()}function B(){d.scrollTop=d.scrollHeight}function w(e,t=""){const r=document.querySelector(".toast");r&&r.remove();const s=document.createElement("div");s.className=`toast ${t}`,s.textContent=e,document.body.appendChild(s),setTimeout(()=>s.remove(),3e3)}async function C(){p||await y();const e=await fetch(`${h}/v1/ingest`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:(a==null?void 0:a.url)||"",title:(a==null?void 0:a.title)||"Untitled",domain:new URL((a==null?void 0:a.url)||"http://unknown").hostname,text:p})});if(!e.ok){const r=await e.json().catch(()=>({}));throw new Error(r.message||"Failed to save")}return i=(await e.json()).recordId,i}function u(e){k.disabled=e,L.disabled=e,b.disabled=e,f.disabled=e}async function A(){try{u(!0),E("帮我总结这个页面的内容"),$(),await y(),await C();const e=await fetch(`${h}/v1/summarize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recordId:i})});if(!e.ok)throw new Error("Failed to summarize");const t=await e.json();m(),l(t.summary,{keyPoints:t.keyPoints,tags:t.tags}),g.disabled=!1}catch(e){m(),l(`抱歉，出错了：${e instanceof Error?e.message:"Unknown error"}`)}finally{u(!1)}}async function _(){try{u(!0),E("帮我进行头脑风暴，多角度思考"),$(),await y(),await C();const e=await fetch(`${h}/v1/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recordId:i,message:`基于这个页面的内容，请帮我进行深度头脑风暴。请从以下几个角度来思考：

1. **核心问题**：这篇内容试图解决什么核心问题？
2. **另一种视角**：如果从相反或不同的角度看，会有什么发现？
3. **类比思考**：这个主题可以类比到哪些其他领域？
4. **延伸问题**：基于这些内容，还有哪些值得深入探索的问题？
5. **实践应用**：如何将这些知识应用到实际中？

请用清晰的结构回答。`})});if(!e.ok)throw new Error("Failed to brainstorm");const t=await e.json();m(),l(t.reply),g.disabled=!1}catch(e){m(),l(`抱歉，出错了：${e instanceof Error?e.message:"Unknown error"}`)}finally{u(!1)}}async function U(){if(!i){w("请先生成总结","error");return}try{if(g.disabled=!0,!(await fetch(`${h}/v1/cards`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recordId:i})})).ok)throw new Error("Failed to save card");w("卡片已保存！","success"),l("知识卡片已成功保存到你的卡片库中！")}catch(e){w(e instanceof Error?e.message:"Error","error")}finally{g.disabled=!1}}async function x(e){if(e.trim())try{u(!0),E(e),f.value="",$(),p||await y(),i||await C();const t=await fetch(`${h}/v1/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recordId:i,message:e})});if(!t.ok)throw new Error("Failed to get response");const r=await t.json();m(),l(r.reply)}catch(t){m(),l(`抱歉，出错了：${t instanceof Error?t.message:"Unknown error"}`)}finally{u(!1)}}k.addEventListener("click",A);L.addEventListener("click",_);g.addEventListener("click",U);T.addEventListener("click",()=>{chrome.tabs.create({url:`${O}/dashboard`})});b.addEventListener("click",()=>{x(f.value)});f.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),x(f.value))});j();
